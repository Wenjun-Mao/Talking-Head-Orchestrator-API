services:
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    restart: always
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "rabbitmq-diagnostics -q ping && rabbitmq-diagnostics -q check_running && rabbitmq-diagnostics -q listeners | grep -q 'port: 5672'",
        ]
      interval: 5s
      timeout: 15s
      retries: 5
      start_period: 20s

  s1-ingest-nocodb:
    build:
      context: ../..
      dockerfile: services/s1-ingest-nocodb/Dockerfile
    ports:
      - "7101:7101"
    secrets:
      - rabbitmq_url
      - nocodb_api_key
      - nocodb_base_url
      - debug_log_payload
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy

  s2-download-mp4:
    build:
      context: ../..
      dockerfile: services/s2-download-mp4/Dockerfile
    environment:
      - S2_QUEUE=s2-download-mp4
    volumes:
      - ../../data:/data
    # profiles:
    #   - s2
    secrets:
      - rabbitmq_url
      - video_parse_api_token
      - debug_log_payload
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy

  s3-tts-voice:
    build:
      context: ../..
      dockerfile: services/s3-tts-voice/Dockerfile
    volumes:
      - ../../data:/data
    # profiles:
    #   - s3
    secrets:
      - rabbitmq_url
      - tts_api_token
      - debug_log_payload
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy

  s4-inference-engine:
    build:
      context: ../..
      dockerfile: services/s4-inference-engine/Dockerfile
    environment:
      - S4_QUEUE=s4-inference-engine
      - S4_FLASHHEAD_CKPT_DIR=/models/SoulX-FlashHead-1_3B
      - S4_WAV2VEC_DIR=/models/wav2vec2-base-960h
      - S4_MODEL_TYPE=lite
      - S4_COND_IMAGE_PATH=/data/imgs/girl.png
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ../../data:/data
      - ../../services/s4-inference-engine/vendor/SoulX-FlashHead/models:/models
    gpus: all
    # profiles:
    #   - s4
    secrets:
      - rabbitmq_url
      - debug_log_payload
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: always

  s5-broll-selector:
    build:
      context: ../..
      dockerfile: services/s5-broll-selector/Dockerfile
    environment:
      - S5_QUEUE=s5-broll-selector
    volumes:
      - ../../data:/data
    # profiles:
    #   - s5
    secrets:
      - rabbitmq_url
      - debug_log_payload
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: always

  s6-video-compositor:
    build:
      context: ../..
      dockerfile: services/s6-video-compositor/Dockerfile
    environment:
      - S6_QUEUE=s6-video-compositor
      - S6_TARGET_TOTAL_BITRATE_MBPS=0.6
      - S6_MIN_TOTAL_BITRATE_MBPS=0.35
      - S6_BITRATE_STEP_KBPS=50
      - S6_AUDIO_BITRATE_KBPS=96
      - S6_MAX_OUTPUT_SIZE_MB=30
    volumes:
      - ../../data:/data
    # profiles:
    #   - s6
    secrets:
      - rabbitmq_url
      - debug_log_payload
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: always

  s7-storage-uploader:
    build:
      context: ../..
      dockerfile: services/s7-storage-uploader/Dockerfile
    environment:
      - S7_QUEUE=s7-storage-uploader
      - S7_CHEVERETO_BASE_URL=https://imagor.wanyouwan.cn
      - S7_CHEVERETO_ALBUM_ID=uvX
      - S7_CHEVERETO_ALBUM_NAME=talking head
      - S7_EXPIRATION_INTERVAL=P3D
    volumes:
      - ../../data:/data
    secrets:
      - rabbitmq_url
      - chevereto_api_key
      - debug_log_payload
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: always

  s8-nocodb-updater:
    build:
      context: ../..
      dockerfile: services/s8-nocodb-updater/Dockerfile
    environment:
      - S8_QUEUE=s8-nocodb-updater
      - S8_UPDATE_FIELD_NAME=chengpinurl
    volumes:
      - ../../data:/data
    secrets:
      - rabbitmq_url
      - nocodb_api_key
      - nocodb_base_url
      - debug_log_payload
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: always

  vector-agent:
    image: timberio/vector:0.44.0-debian
    command: ["--config", "/etc/vector/vector.yaml"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../observability/vector/vector.yaml:/etc/vector/vector.yaml:ro
      - vector-data:/vector-data-dir
    environment:
      - VECTOR_SIGNOZ_OTLP_HTTP_URI=http://signoz-otel-collector:4318/v1/logs
      - VECTOR_PROJECT_NAME=talking-head-orchestrator-api
      - VECTOR_DEPLOYMENT_ENV=local
    networks:
      - signoz-net
    restart: always

secrets:
  rabbitmq_url:
    file: ./secrets/rabbitmq_url
  nocodb_api_key:
    file: ./secrets/nocodb_api_key
  nocodb_base_url:
    file: ./secrets/nocodb_base_url
  video_parse_api_token:
    file: ./secrets/video_parse_api_token
  tts_api_token:
    file: ./secrets/tts_api_token
  debug_log_payload:
    file: ./secrets/debug_log_payload
  chevereto_api_key:
    file: ./secrets/chevereto_api_key

volumes:
  vector-data:

networks:
  signoz-net:
    external: true
    name: signoz-net

