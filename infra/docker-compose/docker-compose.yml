services:
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    restart: always
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 15s
      retries: 5

  s1-ingest-nocodb:
    build:
      context: ../../services/s1-ingest-nocodb
    ports:
      - "7101:7101"
    secrets:
      - rabbitmq_url
      - nocodb_api_key
      - nocodb_base_url
      - debug_log_payload
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy

  s2-download-mp4:
    build:
      context: ../../services/s2-download-mp4
    environment:
      - S2_QUEUE=s2-download-mp4
    volumes:
      - ../../data:/data
    # profiles:
    #   - s2
    secrets:
      - rabbitmq_url
      - video_parse_api_token
      - debug_log_payload
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy

  s3-tts-voice:
    build:
      context: ../../services/s3-tts-voice
    volumes:
      - ../../data:/data
    # profiles:
    #   - s3
    secrets:
      - rabbitmq_url
      - tts_api_token
      - debug_log_payload
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy

  s4-inference-engine:
    build:
      context: ../../services/s4-inference-engine
    environment:
      - S4_QUEUE=s4-inference-engine
      - S4_FLASHHEAD_CKPT_DIR=/models/SoulX-FlashHead-1_3B
      - S4_WAV2VEC_DIR=/models/wav2vec2-base-960h
      - S4_MODEL_TYPE=lite
      - S4_COND_IMAGE_PATH=/data/imgs/girl.png
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ../../data:/data
      - ../../services/s4-inference-engine/vendor/SoulX-FlashHead/models:/models
    gpus: all
    # profiles:
    #   - s4
    secrets:
      - rabbitmq_url
      - debug_log_payload
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: always

  s5-broll-selector:
    build:
      context: ../../services/s5-broll-selector
    environment:
      - S5_QUEUE=s5-broll-selector
    volumes:
      - ../../data:/data
    # profiles:
    #   - s5
    secrets:
      - rabbitmq_url
      - debug_log_payload
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: always

  s6-video-compositor:
    build:
      context: ../../services/s6-video-compositor
    environment:
      - S6_QUEUE=s6-video-compositor
    volumes:
      - ../../data:/data
    # profiles:
    #   - s6
    secrets:
      - rabbitmq_url
      - debug_log_payload
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: always

  s7-storage-uploader:
    build:
      context: ../../services/s7-storage-uploader
    environment:
      - S7_QUEUE=s7-storage-uploader
      - S7_CHEVERETO_BASE_URL=https://imagor.wanyouwan.cn
      - S7_CHEVERETO_ALBUM_ID=uvX
      - S7_CHEVERETO_ALBUM_NAME=talking head
      - S7_EXPIRATION_INTERVAL=P3D
    volumes:
      - ../../data:/data
    secrets:
      - rabbitmq_url
      - chevereto_api_key
      - debug_log_payload
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: always

  s8-nocodb-updater:
    build:
      context: ../../services/s8-nocodb-updater
    environment:
      - S8_QUEUE=s8-nocodb-updater
      - S8_NOCODB_TABLE_ID=murmwwnt5ukvp7i
      - S8_UPDATE_FIELD_NAME=chengpinurl
    volumes:
      - ../../data:/data
    secrets:
      - rabbitmq_url
      - nocodb_api_key
      - nocodb_base_url
      - debug_log_payload
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: always

secrets:
  rabbitmq_url:
    file: ./secrets/rabbitmq_url
  nocodb_api_key:
    file: ./secrets/nocodb_api_key
  nocodb_base_url:
    file: ./secrets/nocodb_base_url
  video_parse_api_token:
    file: ./secrets/video_parse_api_token
  tts_api_token:
    file: ./secrets/tts_api_token
  debug_log_payload:
    file: ./secrets/debug_log_payload
  chevereto_api_key:
    file: ./secrets/chevereto_api_key
